/*!
 * pjax(ajax + history.pushState) for jquery
 * 
 * by welefen
 */
(function(d){var e={support:{pjax:window.history&&window.history.pushState&&window.history.replaceState&&!navigator.userAgent.match(/(iPod|iPhone|iPad|WebApps\/.+CFNetwork)/),storage:!!window.localStorage},toInt:function(f){return parseInt(f)},stack:{},getTime:function(){return new Date*1},getRealUrl:function(f){f=(f||"").replace(/\#.*?$/,"");f=f.replace("?pjax=true&","?").replace("?pjax=true","").replace("&pjax=true","");return f},getUrlHash:function(f){return f.replace(/^[^\#]*(?:\#(.*?))?$/,"$1")},getLocalKey:function(g){var f="pjax_"+encodeURIComponent(g);return{data:f+"_data",time:f+"_time",title:f+"_title"}},removeAllCache:function(){if(!e.support.storage){return}for(var f in localStorage){if((f.split("_")||[""])[0]==="pjax"){delete localStorage[f]}}},getCache:function(n,m,g){var j,i,k,h;m=e.toInt(m);if(n in e.stack){j=e.stack[n],ctime=e.getTime();if((j.time+m*1000)>ctime){return j}else{delete e.stack[n]}}else{if(g&&e.support.storage){var f=e.getLocalKey(n);i=f.data;k=f.time;j=localStorage.getItem(i);if(j){h=e.toInt(localStorage.getItem(k));if((h+m*1000)>e.getTime()){return{data:j,title:localStorage.getItem(f.title)}}else{localStorage.removeItem(i);localStorage.removeItem(k);localStorage.removeItem(f.title)}}}}return null},setCache:function(k,h,j,f){var i=e.getTime(),g;e.stack[k]={data:h,title:j,time:i};if(f&&e.support.storage){g=e.getLocalKey(k);localStorage.setItem(g.data,h);localStorage.setItem(g.time,i);localStorage.setItem(g.title,j)}},removeCache:function(g){g=e.getRealUrl(g||location.href);delete e.stack[g];if(e.support.storage){var f=e.getLocalKey(g);localStorage.removeItem(f.data);localStorage.removeItem(f.time);localStorage.removeItem(f.title)}}};var c=function(f){opt=c.options=d.extend(c.defaultOptions,f);if(!opt.container||!opt.selector){throw new Error("selector & container options must be set")}d("body").delegate(opt.selector,"click",function(h){if(h.which>1||h.metaKey){return true}var i=d(this),g=i.attr("href");if(typeof opt.filter==="function"){if(opt.filter.call(this,g,this)===true){return true}}if(g===location.href){return true}c.send({},g,this);h.preventDefault()})};c.send=function(h,f,i){var g=c.options=d.extend(c.defaultOptions,h);if(e.getRealUrl(f)==e.getRealUrl(location.href)){var j=e.getUrlHash(f);if(j){location.hash=j;g.callback&&g.callback.call(this,{type:"hash"})}return true}g=d.extend(true,g,{url:f,element:i,push:true});c.request()};c.xhr=null;c.options={};c.state={};c.defaultOptions={timeout:2000,element:null,cache:24*3600,storage:true,url:"",push:true,show:"",title:"",titleSuffix:"",type:"GET",data:{pjax:true},dataType:"html",callback:null,beforeSend:function(f){d(c.options.container).trigger("pjax.start",[f,c.options]);f&&f.setRequestHeader("X-PJAX",true)},error:function(){c.options.callback&&c.options.callback.call(c.options.element,{type:"error"});location.href=c.options.url},complete:function(f){d(c.options.container).trigger("pjax.end",[f,c.options])}};c.showFx={_default:function(g,h,f){this.html(g);h&&h.call(this,g,f)},fade:function(g,i,f){var h=this;if(f){h.html(g);i&&i.call(h,g,f)}else{this.fadeOut(500,function(){h.html(g).fadeIn(500,function(){i&&i.call(h,g,f)})})}}};c.showFn=function(k,i,j,g,f){var h=null;if(typeof k==="function"){h=k}else{if(!(k in c.showFx)){k="_default"}h=c.showFx[k]}h&&h.call(i,j,function(){var l=location.hash;if(l!=""){location.href=l;if(/Firefox/.test(navigator.userAgent)){history.replaceState(d.extend({},c.state,{url:null}),document.title)}}else{window.scrollTo(0,0)}g&&g.call(this,j,f)},f)};c.success=function(j,g){if(g!==true){g=false}if(c.html){j=d(j).find(c.html).html()}if((j||"").indexOf("<html")!=-1){c.options.callback&&c.options.callback.call(c.options.element,{type:"error"});location.href=c.options.url;return false}var k=c.options.title||"",f;if(k==""&&c.options.element){f=d(c.options.element);k=f.attr("title")||f.text()}var i=j.match(/<title>(.*?)<\/title>/);if(i){k=i[1]}if(k){if(k.indexOf(c.options.titleSuffix)==-1){k+=c.options.titleSuffix}}document.title=k;c.state={container:c.options.container,timeout:c.options.timeout,cache:c.options.cache,storage:c.options.storage,show:c.options.show,title:k,url:c.options.oldUrl};var h=d.param(c.options.data);if(h!=""){c.state.url=c.options.url+(/\?/.test(c.options.url)?"&":"?")+h}if(c.options.push){if(!c.active){history.replaceState(d.extend({},c.state,{url:null}),document.title);c.active=true}history.pushState(c.state,document.title,c.options.oldUrl)}else{if(c.options.push===false){history.replaceState(c.state,document.title,c.options.oldUrl)}}c.options.showFn&&c.options.showFn(j,function(){c.options.callback&&c.options.callback.call(c.options.element,{type:g?"cache":"success"})},g);if(c.options.cache&&!g){e.setCache(c.options.url,j,k,c.options.storage)}};c.request=function(g){var g=c.options;var f,h=d(g.container);g.oldUrl=g.url;g.url=e.getRealUrl(g.url);if(d(g.element).length){f=e.toInt(d(g.element).attr("data-pjax-cache"));if(f){g.cache=f}}if(g.cache===true){g.cache=24*3600}g.cache=e.toInt(g.cache);if(g.cache===0){e.removeAllCache()}if(!g.showFn){g.showFn=function(k,j,i){c.showFn(g.show,h,k,j,i)}}c.options=g;console.log(c.options.callback,g);c.options.success=c.success;if(g.cache&&(f=e.getCache(g.url,g.cache,g.storage))){g.beforeSend();g.title=f.title;c.success(f.data,true);g.complete();return true}if(c.xhr&&c.xhr.readyState<4){c.xhr.onreadystatechange=d.noop;c.xhr.abort()}c.xhr=d.ajax(c.options)};var a=("state" in window.history),b=location.href;d(window).bind("popstate",function(g){var f=!a&&location.href==b;a=true;if(f){return}var i=g.state;if(i&&i.container){if(d(i.container).length){var h={url:i.url,container:i.container,push:null,timeout:i.timeout,cache:i.cache,storage:i.storage,title:i.title,element:null};c.request(h)}else{window.location=location.href}}});if(!e.support.pjax){c=function(){return true};c.request=function(f){if(c.options&&c.options.url){location.href=f.url}}}d.pjax=c;d.pjax.util=e;if(d.inArray("state",d.event.props)<0){d.event.props.push("state")}})(jQuery);
